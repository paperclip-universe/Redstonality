on:
  push:
    paths:
      - .version
  workflow_dispatch:
    inputs:
      skip-build:
        description: "Skip build step"
        required: false
        default: "true"

jobs:
  create-release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        name: Checkout
      # Install NodeJS, pnpm, and Go
      - uses: actions/setup-node@v3
        with:
          node-version: latest
        name: Install NodeJS
      - uses: actions/setup-go@v4
        with:
          go-version: stable
        name: Install Go
      - uses: pnpm/action-setup@v2
        with:
          version: latest
        name: Install PNPM
      # Install packwiz
      - run: go install github.com/packwiz/packwiz@latest
        name: Install Packwiz
      # Install pnpm dependencies
      - run: pnpm install
        name: Install dependencies
      # Run scripts
      - run: pnpm build
        if: ${{ github.event.inputs.skip-build != 'true' }}
        name: Build modpack
      - run: pnpm run build:generate
        if: ${{ github.event.inputs.skip-build == 'true' }}
        name: Generate modpack
      # Get version
      - run: echo "MODPACK_VERSION=$(cat .version)" >> $GITHUB_OUTPUT
        name: Get version
        id: version
      # List all files that aren't 1.19.4
      - run: echo "FILES=$(find out -type f -not -name '*1.19.4.mrpack' | sed 's/ /\\ /g' | perl -pe 's/\n/ /g')" >> $GITHUB_OUTPUT
        name: Get files
        id: files
      # Release artifacts
      - uses: Kir-Antipov/mc-publish@v3.2
        with:
          modrinth-id: Fe2hWp6Z
          modrinth-token: ${{ secrets.MODRINTH_TOKEN }}
          modrinth-unfeature-mode: subset
          files-primary: "out/*1.19.4.mrpack"
          # All the non-1.19.4 files are uploaded as secondary files
          files-secondary: ${{ steps.files.outputs.FILES }}
          loaders: quilt
          version: ${{ steps.version.outputs.MODPACK_VERSION }}
          game-versions: |
            1.15.2
            1.16.1
            1.16.2
            1.16.3
            1.16.4
            1.16.5
            1.17
            1.17.1
            1.18
            1.18.1
            1.18.2
            1.19
            1.19.1
            1.19.2
            1.19.3
            1.19.4
